var SolrWidget=function(e,t,n){function r(e){return decodeURIComponent(e).replace(/\+/g," ")}function a(e){for(var t=[],n=0;n<e.length;n++)t.push(encodeURIComponent(e[n].name)+"="+encodeURIComponent(e[n].value));return t.join("&")}var i=function(e){return function(){return m.redraw.strategy("diff"),e.apply(this,arguments)}},s=[{name:"wt",value:"json"},{name:"facet",value:"true"}];return e.vm={init:function(){var e=m.route.param("q")?r(m.route.param("q")):"";this.q=m.prop(e),this.isSearching=!1,this.docs=this.docs||m.prop([]),this.facets=this.facets||m.prop({}),this.numFound=this.numFound||m.prop(0),this.perPage=m.prop(m.route.param("rows")||20),this.currentPage=m.prop(0),m.route.param("start")&&m.route.param("rows")&&this.currentPage(Math.ceil(m.route.param("start")/m.route.param("rows")))}},e.cache={},e.view=function(t,n){return m(".msolr",[m.component(e.SearchForm,{onSubmit:t.route,isSearching:e.vm.isSearching,q:e.vm.q,numFound:e.vm.numFound}),m(".msolr-content",[m.component(e.Pagination,{perPage:e.vm.perPage,numFound:e.vm.numFound,currentPage:e.vm.currentPage,changePage:t.changePage,nextPage:t.nextPage,prevPage:t.prevPage}),m.component(e.SearchSelectedFacets,{selectedFacets:t.selectedFacets,facetFields:n.facetFields,removeFacet:t.removeFacet}),m.component(e.SearchFacets,{facets:e.vm.facets,facetFields:n.facetFields,onSelect:t.facetSelect}),m.component(e.SearchResults,{docs:e.vm.docs,fields:n.fields,q:e.vm.q,isSearching:e.vm.isSearching}),m.component(e.Pagination,{perPage:e.vm.perPage,numFound:e.vm.numFound,currentPage:e.vm.currentPage,changePage:t.changePage,nextPage:t.nextPage,prevPage:t.prevPage})])])},e.controller=new i(function(t){var i=this;if(e.vm.init(),this.facetFields=[],t.facetFields)for(var c in t.facetFields)this.facetFields.push({name:"facet.field",value:c});if(this.selectedFacets=[],m.route.param("fq")){var o=m.route.param("fq");"string"==typeof o&&(o=o.replace(/\"/g,'\\"'),o=JSON.parse('["'+o+'"]')),o.map(function(e){i.selectedFacets.push({name:"fq",value:r(e)})})}this.removeFacet=function(t,n){n&&n.preventDefault();for(var r=0;r<this.selectedFacets.length;r++)this.selectedFacets[r].value==t.value&&this.selectedFacets.splice(r,1);e.vm.currentPage(0),this.route()}.bind(this),this.facetSelect=function(t,n,r){r&&r.preventDefault(),this.selectedFacets.push({name:"fq",value:t+':"'+n+'"'}),e.vm.currentPage(0),this.route()}.bind(this),this.changePage=function(t,n){n&&n.preventDefault(),e.vm.currentPage(t),this.route()}.bind(this),this.prevPage=function(t,n){n&&n.preventDefault();var r=e.vm.currentPage();--r,0>r&&(r=0),e.vm.currentPage(r),this.route()}.bind(this),this.nextPage=function(t,n){n&&n.preventDefault();var r=e.vm.currentPage();++r,r>t-1&&(r=t-1),e.vm.currentPage(r),this.route()}.bind(this),this.buildParams=function(){var t=[{name:"q",value:e.vm.q()}],r=[{name:"rows",value:e.vm.perPage()},{name:"start",value:e.vm.currentPage()*e.vm.perPage()}],a=[].concat.apply([],[this.facetFields,s,this.selectedFacets,t,r]);return a=a.filter(function(e){return e!=n})}.bind(this),this.route=function(e){e&&e.preventDefault(),queryString=a(this.buildParams()),m.route("/search?"+queryString)}.bind(this),this.search=function(t){t&&t.preventDefault(),e.vm.q()&&(e.vm.isSearching=!0,this.fetch().then(function(t){e.vm.docs(t.response.docs),e.vm.facets(t.facet_counts||""),e.vm.numFound(t.response.numFound),e.vm.isSearching=!1,m.redraw()}))}.bind(this),this.fetch=function(){var n=a(this.buildParams()),r=JSON.stringify(n);return e.cache[r]||(e.cache[r]=m.request({url:t.endPoint+"?"+n,dataType:"jsonp",callbackKey:"json.wrf",background:!0}).then(function(e){return e})),e.cache[r]}.bind(this),e.vm.q()?this.search():(e.vm.docs([]),e.vm.facets({}),e.vm.numFound(0),e.vm.currentPage(0))}),e}(SolrWidget||{},window);!function(e,t,n){var r={ellipsis:"&hellip;",edges:2,limit:10};e.Pagination={controller:function(e){this.totalPages=function(t){return Math.ceil(e.numFound()/t)}.bind(this),this.pageList=function(e,t){for(var n=[],a=this.totalPages(t),i=0,s=a,c=Math.max(parseInt(e)-r.edges,0),o=Math.min(parseInt(e)+r.edges,a),u=i;s>u;u++)0==u||u==parseInt(a)-1||a<r.limit?n.push(u):((u==o+1||u==c-1)&&n.push(r.ellipsis),o>=u&&u>=c&&n.push(u));return n}.bind(this)},view:function(e,t){var n=e.pageList(t.currentPage(),t.perPage()),a=e.totalPages(t.perPage());return m("nav.msolr-pages",{style:{display:n.length>1?"":"none"}},[m("a.previous",{onclick:t.prevPage.bind(this,a),className:0==t.currentPage()?"page-disabled":""},"Prev"),n.map(function(n){switch(n){case r.ellipsis:return m("span.page-ellipsis",m.trust(n));default:return m("a",{onclick:t.changePage.bind(e,parseInt(n)),className:n==t.currentPage()?"page-current":""},parseInt(n)+1)}}),m("a.next",{onclick:t.nextPage.bind(this,a),className:t.currentPage()==a-1?"page-disabled":""},"Next")])}}}(SolrWidget||{},window),function(e,t,n){e.SearchFacets={controller:function(){},facetList:function(e,t,n){for(var r=[],a=0;a<e.length;a+=2)e[a+1]>0&&r.push(m("li",m("a",{href:"#",onclick:n.onSelect.bind(this,t,e[a])},e[a],[m("span.msolr-facet-count",e[a+1])])));return m("ul",[r])},view:function(e,t){var n=t.facets(),r=[];for(var a in n)if(n.hasOwnProperty(a)){var i=n[a];if("facet_fields"==a)for(var s in i)i.hasOwnProperty(s)&&i[s].length&&r.push(m(".facet-field",[m("h3",t.facetFields[s]),this.facetList(i[s],s,t)]))}return m(".msolr-filters",[r])}}}(SolrWidget||{},window),function(e,t,n){e.SearchForm={controller:function(){},view:function(e,t){return m(".msolr-form",[m("form",{onsubmit:t.onSubmit},[m("input",{type:"text",defaultValue:t.q(),onchange:m.withAttr("value",t.q),placeholder:"Enter a keyword"}),m("button",t.isSearching?"Searching":"Search")]),m("h3",{style:{display:t.numFound()>0?"":"none"}},t.numFound()+" results found for "+t.q())])}}}(SolrWidget||{},window),function(e,t,n){e.SearchResults={controller:function(){},noResults:function(e,t){return e.length<1&&t.q()&&!t.isSearching?m(".msolr-no-results","Your search did not return any results."):void 0},view:function(e,t){var n=t.docs();return m(".msolr-results",[m("ul",[n.map(function(e){return m("li",[m("h3",m("a",{href:e[t.fields.url]},e[t.fields.title])),m(".summary",[m("p",e[t.fields.summary])])])})]),this.noResults(n,t)])}}}(SolrWidget||{},window),function(e,t,n){e.SearchSelectedFacets={controller:function(e){this.selections=e.selectedFacets||[],this.groups=function(e){var t=[];return e.map(function(e){var n=e.value.split(":"),r=n[0],a=n[1];t[r]=t[r]||[],t[r].push({name:a,value:r+":"+a})}),t}},facetList:function(e,t,n){return e.map(function(e){return m("li",e.name,[m("a",{onclick:n.removeFacet.bind(this,e)}," x Remove")])})},view:function(t,n){var r=[],a=t.groups(n.selectedFacets);for(var i in a)a.hasOwnProperty(i)&&r.push(m(".msolr-selected-facet",[m("h5",n.facetFields[i]),e.SearchSelectedFacets.facetList(a[i],i,n)]));return m(".msolr-selected-facets",[r])}}}(SolrWidget||{},window);