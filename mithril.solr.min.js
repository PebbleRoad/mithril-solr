var SolrWidget=function(e,t,n){function a(e){return decodeURIComponent(e).replace(/\+/g," ")}var r=function(e){return function(){return m.redraw.strategy("diff"),e.apply(this,arguments)}},i=[{name:"wt",value:"json"},{name:"json.wrf",value:"callback"},{name:"facet",value:"true"}];return e.vm={init:function(){var e=m.route.param("q")?a(m.route.param("q")):"";this.q=m.prop(e),this.isSearching=!1,this.docs=this.docs||m.prop([]),this.facets=this.facets||m.prop({}),this.numFound=this.numFound||m.prop(0),this.perPage=m.prop(m.route.param("rows")||20),this.currentPage=m.prop(0),m.route.param("start")&&m.route.param("rows")&&this.currentPage(Math.ceil(m.route.param("start")/m.route.param("rows")))}},e.cache={},e.view=function(t,n){return m(".msolr",[m.component(e.SearchForm,{onSubmit:t.search,isSearching:e.vm.isSearching,q:e.vm.q,numFound:e.vm.numFound}),m(".msolr-content",[m.component(e.Pagination,{perPage:e.vm.perPage,numFound:e.vm.numFound,currentPage:e.vm.currentPage,changePage:t.changePage,nextPage:t.nextPage,prevPage:t.prevPage}),m.component(e.SearchSelectedFacets,{selectedFacets:t.selectedFacets,facetFields:n.facetFields,removeFacet:t.removeFacet}),m.component(e.SearchFacets,{facets:e.vm.facets,facetFields:n.facetFields,onSelect:t.facetSelect}),m.component(e.SearchResults,{docs:e.vm.docs,fields:n.fields,q:e.vm.q,isSearching:e.vm.isSearching}),m.component(e.Pagination,{perPage:e.vm.perPage,numFound:e.vm.numFound,currentPage:e.vm.currentPage,changePage:t.changePage,nextPage:t.nextPage,prevPage:t.prevPage})])])},e.controller=new r(function(t){var r=this;if(e.vm.init(),this.facetFields=[],t.facetFields)for(var s in t.facetFields)this.facetFields.push({name:"facet.field",value:s});if(this.selectedFacets=[],m.route.param("fq")){var c=m.route.param("fq");"string"==typeof c&&(c=c.replace(/\"/g,'\\"'),c=JSON.parse('["'+c+'"]')),c.map(function(e){r.selectedFacets.push({name:"fq",value:a(e)})})}this.removeFacet=function(t,n){n&&n.preventDefault();for(var a=0;a<this.selectedFacets.length;a++)this.selectedFacets[a].value==t.value&&this.selectedFacets.splice(a,1);e.vm.currentPage(0),this.route()}.bind(this),this.facetSelect=function(t,n,a){a&&a.preventDefault(),this.selectedFacets.push({name:"fq",value:t+':"'+n+'"'}),e.vm.currentPage(0),this.route()}.bind(this),this.changePage=function(t,n){n&&n.preventDefault(),e.vm.currentPage(t),this.route()}.bind(this),this.prevPage=function(t,n){n&&n.preventDefault();var a=e.vm.currentPage();--a,0>a&&(a=0),e.vm.currentPage(a),this.route()}.bind(this),this.nextPage=function(t,n){n&&n.preventDefault();var a=e.vm.currentPage();++a,a>t-1&&(a=t-1),e.vm.currentPage(a),this.route()}.bind(this),this.buildParams=function(){var t=[{name:"q",value:e.vm.q()}],a=[{name:"rows",value:e.vm.perPage()},{name:"start",value:e.vm.currentPage()*e.vm.perPage()}],r=[].concat.apply([],[this.facetFields,i,this.selectedFacets,t,a]);return r=r.filter(function(e){return e!=n})}.bind(this),this.route=function(e){e&&e.preventDefault(),queryString=$.param(this.buildParams()),m.route("/search?"+queryString)}.bind(this),this.search=function(){e.vm.q()&&(e.vm.isSearching=!0,this.fetch().then(function(t){e.vm.docs(t.response.docs),e.vm.facets(t.facet_counts||""),e.vm.numFound(t.response.numFound),e.vm.isSearching=!1,m.redraw()}))}.bind(this),this.fetch=function(){var n=this.buildParams(),a=JSON.stringify(n);return e.cache[a]||(e.cache[a]=$.ajax({url:t.endPoint,data:n,dataType:"jsonp",jsonpCallback:"callback"}).done(function(e){return e})),e.cache[a]}.bind(this),e.vm.q()?this.search():(e.vm.docs([]),e.vm.facets({}),e.vm.numFound(0),e.vm.currentPage(0))}),e}(SolrWidget||{},window);!function(e,t,n){var a={ellipsis:"&hellip;",edges:2,limit:10};e.Pagination={controller:function(e){this.totalPages=function(t){return Math.ceil(e.numFound()/t)}.bind(this),this.pageList=function(e,t){for(var n=[],r=this.totalPages(t),i=0,s=r,c=Math.max(parseInt(e)-a.edges,0),o=Math.min(parseInt(e)+a.edges,r),u=i;s>u;u++)0==u||u==parseInt(r)-1||r<a.limit?n.push(u):((u==o+1||u==c-1)&&n.push(a.ellipsis),o>=u&&u>=c&&n.push(u));return n}.bind(this)},view:function(e,t){var n=e.pageList(t.currentPage(),t.perPage()),r=e.totalPages(t.perPage());return m("nav.msolr-pages",{style:{display:n.length>1?"":"none"}},[m("a.previous",{onclick:t.prevPage.bind(this,r),className:0==t.currentPage()?"page-disabled":""},"Prev"),n.map(function(n){switch(n){case a.ellipsis:return m("span.page-ellipsis",m.trust(n));default:return m("a",{onclick:t.changePage.bind(e,parseInt(n)),className:n==t.currentPage()?"page-current":""},parseInt(n)+1)}}),m("a.next",{onclick:t.nextPage.bind(this,r),className:t.currentPage()==r-1?"page-disabled":""},"Next")])}}}(SolrWidget||{},window),function(e,t,n){e.SearchFacets={controller:function(){},facetList:function(e,t,n){for(var a=[],r=0;r<e.length;r+=2)e[r+1]>0&&a.push(m("li",m("a",{href:"#",onclick:n.onSelect.bind(this,t,e[r])},e[r],[m("span.msolr-facet-count",e[r+1])])));return m("ul",[a])},view:function(e,t){var n=t.facets(),a=[];for(var r in n)if(n.hasOwnProperty(r)){var i=n[r];if("facet_fields"==r)for(var s in i)i.hasOwnProperty(s)&&i[s].length&&a.push(m(".facet-field",[m("h3",t.facetFields[s]),this.facetList(i[s],s,t)]))}return m(".msolr-filters",[a])}}}(SolrWidget||{},window),function(e,t,n){e.SearchForm={controller:function(){},view:function(e,t){return m(".msolr-form",[m("form",{onsubmit:t.onSubmit},[m("input",{type:"text",defaultValue:t.q(),onchange:m.withAttr("value",t.q),placeholder:"Start typing to see instant results"}),m("button",t.isSearching?"Searching":"Search")]),m("h3",{style:{display:t.numFound()>0?"":"none"}},t.numFound()+" results found for "+t.q())])}}}(SolrWidget||{},window),function(e,t,n){e.SearchResults={controller:function(){},noResults:function(e,t){return e.length<1&&t.q()&&!t.isSearching?m(".msolr-no-results","Your search did not return any results."):void 0},view:function(e,t){var n=t.docs();return m(".msolr-results",[m("ul",[n.map(function(e){return m("li",[m("h3",m("a",{href:e[t.fields.url]},e[t.fields.title])),m(".summary",[m("p",e[t.fields.summary])])])})]),this.noResults(n,t)])}}}(SolrWidget||{},window),function(e,t,n){e.SearchSelectedFacets={controller:function(e){this.selections=e.selectedFacets||[],this.groups=function(e){var t=[];return e.map(function(e){var n=e.value.split(":"),a=n[0],r=n[1];t[a]=t[a]||[],t[a].push({name:r,value:a+":"+r})}),t}},facetList:function(e,t,n){return e.map(function(e){return m("li",e.name,[m("a",{onclick:n.removeFacet.bind(this,e)}," x Remove")])})},view:function(t,n){var a=[],r=t.groups(n.selectedFacets);for(var i in r)r.hasOwnProperty(i)&&a.push(m(".msolr-selected-facet",[m("h5",n.facetFields[i]),e.SearchSelectedFacets.facetList(r[i],i,n)]));return m(".msolr-selected-facets",[a])}}}(SolrWidget||{},window);